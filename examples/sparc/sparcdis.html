<html><head><title> sparcdis.nw</title></head><body><h2>SPARC disassembler</h2>
<p>
<a name="NWD1">Disassembler for the SPARC by Cristina Cifuentes and Norman Ramsey</a>
<p>
Revision history:
<blockquote>
<blockquote>
Date --- Toolkit Version --- Author<br>Sep 1995 --- 0.1a (Dec 1994) --- Cifuentes<br>Jan 1996 --- 0.3 (Dec 1995) --- Cifuentes<br>Mar 1996 --- 0.4 (Mar 1996) --- Ramsey
</blockquote>
</blockquote>
<p>
<pre><a name="NWspaB-spaD-1" href="#NWD1"><dfn>&lt;sparcdis.spec&gt;=</dfn></a>
<a name="NWspaB-spaD-1-u1" href="#NWDA"><i>&lt;syntax patterns&gt;</i></a>
<a name="NWspaB-spaD-1-u2" href="#NWspaB-fetE-1"><i>&lt;fetching specs&gt;</i></a>
</pre><pre><a name="NWspaB-spaA-1" href="#NWspaB-spaA-1"><dfn>&lt;sparcdis.m&gt;=</dfn></a>
#include &lt;stdio.h&gt;
#include &lt;mclib.h&gt;
#include &quot;sparc-names.h&quot;   /* generated by 'tools -fieldnames' - has
                                   arrays of names of fields */
#include &quot;sparcdis.h&quot;

<a name="NWspaB-spaA-1-u1" href="#NWD4"><i>&lt;macros&gt;</i></a>
<a name="NWspaB-spaA-1-u2" href="#NWD5"><i>&lt;definitions&gt;</i></a>
</pre><p>
<pre><a name="NWspaB-spaA.2-1" href="#NWspaB-spaA.2-1"><dfn>&lt;sparcdis.h&gt;=</dfn></a>
<a name="NWspaB-spaA.2-1-u1" href="#NWD3"><i>&lt;exported declarations&gt;</i></a>
</pre><p>
The general idea is to disassemble a single instruction in memory.
<a name="NWD2">I parameterize the disassembler by three functions:</a>
<ul>
<li>Ability to fetch a word from memory
<li>Ability to convert a relocatable address to a string
<li>Ability to print an instruction
</ul>
I don't solve the usual problem of functions returning strings, but
the code below should work with statically allocated strings.
The real solution is garbage collection, perhaps &agrave; la Boehm-Weiser.

<code><a name="NWD3">print</a></code> is a varargs printing procedure with the same interface
as printf.
<code>pr</code>, <code>rel</code>, and <code>fet</code> are closures.
<pre><a name="NWspaB-expL-1" href="#NWD3"><dfn>&lt;exported declarations&gt;=</dfn></a> <b>(<a href="#NWspaB-spaA.2-1">&lt;-U</a>)</b>
typedef void (*<a href="#NWD3">Printer</a>)(void *pr, char *fmt, ...);
typedef char *(*<a href="#NWD3">RelPrinter</a>)(void *rel, unsigned address);
typedef unsigned (*<a href="#NWD3">Fetcher</a>)(void *f, unsigned lc);
extern void <a href="#NWspaB-defB-4">sparc_disassemble</a>(unsigned lc, 
        <a href="#NWD3">Printer</a> print, void *pr, <a href="#NWD3">RelPrinter</a> dis_rel, void *rel,
        <a href="#NWD3">Fetcher</a> fetch_word, void *fet);
</pre><blockquote>Defines <a href="#NWI-Fetcher"><code>Fetcher</code></a>, <a href="#NWI-Printer"><code>Printer</code></a>, <a href="#NWI-RelPrinter"><code>RelPrinter</code></a> (links are to index).<p>
</blockquote><pre><a name="NWspaB-fetE-1" href="#NWspaB-fetE-1"><dfn>&lt;fetching specs&gt;=</dfn></a> <b>(<a href="#NWD1">&lt;-U</a>)</b>
address type is &quot;unsigned&quot;
address to integer using &quot;%a&quot;
address add using &quot;%a+%o&quot;
fetch 32 using &quot;fetch_word(fet, %a)&quot;
</pre><p>
<a name="NWD4">We find it useful to define macros for converting common operands to strings:</a>
<pre><a name="NWspaB-mac6-1" href="#NWD4"><dfn>&lt;macros&gt;=</dfn></a> <b>(<a href="#NWspaB-spaA-1">&lt;-U</a>)</b>
#define <a href="#NWD4">RD</a>   (rd_names[rd])
#define <a href="#NWD4">RS1</a>  (rs1_names[rs1])
#define <a href="#NWD4">RS2</a>  (rs2_names[rs2])
#define <a href="#NWD4">FD</a>   (fd_names[fd])
#define <a href="#NWD4">FS1</a>  (fs1_names[fs1])
#define <a href="#NWD4">FS2</a>  (fs2_names[fs2])
#define <a href="#NWD4">CD</a>   (cd_names[cd])
#define <a href="#NWD4">ROI</a>  (<a href="#NWD7">dis_roi</a>(fetch_word, fet, roi))
#define <a href="#NWD4">ADDR</a> (<a href="#NWD5">dis_addr</a>(fetch_word, fet, addr))

</pre><blockquote>Defines <a href="#NWI-ADDR"><code>ADDR</code></a>, <a href="#NWI-CD"><code>CD</code></a>, <a href="#NWI-FD"><code>FD</code></a>, <a href="#NWI-FS1"><code>FS1</code></a>, <a href="#NWI-FS2"><code>FS2</code></a>, <a href="#NWI-RD"><code>RD</code></a>, <a href="#NWI-ROI"><code>ROI</code></a>, <a href="#NWI-RS1"><code>RS1</code></a>, <a href="#NWI-RS2"><code>RS2</code></a> (links are to index).<p>
</blockquote><p>
<a name="NWD5">I begin by showing how to disassemble addressing modes and structured operands.</a>
Because memory management in C is so grotesque, I simply disassemble
them into static strings, and I insist that the code below not call
more than one per instruction.
Garbage collection would be a better solution.
Note the ``synthetic'' special cases precede the general ones.
<pre><a name="NWspaB-defB-1" href="#NWD5"><dfn>&lt;definitions&gt;=</dfn></a> <b>(<a href="#NWspaB-spaA-1">&lt;-U</a>)</b> <b>[D<a href="#NWD7">-&gt;</a>]</b>
char *<a href="#NWD5">dis_addr</a>(<a href="#NWD3">Fetcher</a> fetch_word, void *fet, unsigned lc) {
  static char buf[80];
  match lc to
  | indirectA(rs1)   =&gt; return <a href="#NWD4">RS1</a>;
  | indexA(rs1, rs2) =&gt; sprintf(buf, &quot;%s+%s&quot;, <a href="#NWD4">RS1</a>, <a href="#NWD4">RS2</a>);
  | absoluteA(i)     =&gt; sprintf(buf, &quot;%d&quot;, i);
  | dispA(rs1, i)    =&gt; sprintf(buf, &quot;%s%s%d&quot;, <a href="#NWD4">RS1</a>, (int)i &lt; 0 ? &quot;&quot; : &quot;+&quot;, i);
  endmatch
  return buf;
}
</pre><blockquote>Defines <a href="#NWI-dis_addr"><code>dis_addr</code></a> (links are to index).<p>
</blockquote><p><a name="NWD6">Also note the sign hacking for </a><code>dispA</code>.
<p>

<a name="NWD7">A similar function is needed to disassemble </a><em>register or
immediate</em>.
<pre><a name="NWspaB-defB-2" href="#NWD5"><dfn>&lt;definitions&gt;+=</dfn></a> <b>(<a href="#NWspaB-spaA-1">&lt;-U</a>)</b> <b>[<a href="#NWD5">&lt;-</a>D<a href="#NWD8">-&gt;</a>]</b>
char *<a href="#NWD7">dis_roi</a>(<a href="#NWD3">Fetcher</a> fetch_word, void *fet, unsigned lc) {
  static char buf[80];
  match lc to
  | imode(i)   =&gt; sprintf(buf, &quot;%d&quot;, i); return buf;
  | rmode(rs2) =&gt; return <a href="#NWD4">RS2</a>;
  endmatch
}
</pre><blockquote>Defines <a href="#NWI-dis_roi"><code>dis_roi</code></a> (links are to index).<p>
</blockquote><p>
<a name="NWD8">Finally, register addresses for those restricted load and store modes.</a>
<pre><a name="NWspaB-defB-3" href="#NWD5"><dfn>&lt;definitions&gt;+=</dfn></a> <b>(<a href="#NWspaB-spaA-1">&lt;-U</a>)</b> <b>[<a href="#NWD7">&lt;-</a>D<a href="#NWspaB-defB-4">-&gt;</a>]</b>
char *<a href="#NWD8">dis_regaddr</a>(<a href="#NWD3">Fetcher</a> fetch_word, void *fet, unsigned lc) {
  static char buf[80];
  match lc to
  | indirectR(rs1)   =&gt; return <a href="#NWD4">RS1</a>;
  | indexR(rs1, rs2) =&gt; sprintf(buf, &quot;%s+%s&quot;, <a href="#NWD4">RS1</a>, <a href="#NWD4">RS2</a>);
  else                  sprintf(buf, &quot;??%s??&quot;, <a href="#NWD5">dis_addr</a>(fetch_word, fet, lc)); 
  endmatch
  return buf;
}
</pre><blockquote>Defines <a href="#NWI-dis_regaddr"><code>dis_regaddr</code></a> (links are to index).<p>
</blockquote><p>
<a name="NWD9">Now disassembly of full instructions, which ought to return the</a>
successor instruction (because of synthetics) but doesn't.
Disassembles one instruction at location <code>lc</code>.
The matching statement takes the synthetic instructions first and then
all other instructions.  Instructions need to be in priority order, as the
toolkit matches the first arm that becomes true and doesn't look at the
remaining arms.

<a name="NWDA">And we add these patterns to group instructions of like syntax:</a>
<pre><a name="NWspaB-synF-1" href="#NWDA"><dfn>&lt;syntax patterns&gt;=</dfn></a> <b>(<a href="#NWD1">&lt;-U</a>)</b>
patterns 
  load_greg is loadg | LDD 
  load_freg is LDF | LDDF
  load_creg is LDC | LDDC
  load_asi  is loada | LDDA

  sto_greg is storeg | STD 
  sto_freg is STF | STDF
  sto_creg is STC | STDC
  sto_asi  is storea | STDA

  float_2    is  float2s | FSQRTd | FSQRTq | FTOs | FTOd | FTOq | FdTO | FqTO 
                 | FqTOd | FdTOq
  float_3    is  float3s | float3d | float3q | FsMULd | FdMULq
  float_cmp  is fcompares | fcompared | fcompareq 
</pre><p>
<pre><a name="NWspaB-defB-4" href="#NWD5"><dfn>&lt;definitions&gt;+=</dfn></a> <b>(<a href="#NWspaB-spaA-1">&lt;-U</a>)</b> <b>[<a href="#NWD8">&lt;-</a>D]</b>
void <a href="#NWspaB-defB-4">sparc_disassemble</a>(unsigned lc, 
        <a href="#NWD3">Printer</a> print, void *pr, <a href="#NWD3">RelPrinter</a> dis_rel, void *rel,
        <a href="#NWD3">Fetcher</a> fetch_word, void *fet) {
  match lc to
  | NOP                   =&gt; print(pr, &quot;nop&quot;);
   /*   | decode_sethi(hi, r); bset(imode(lo), r) =&gt; 
                print(pr, &quot;set 0x%x, %s&quot;, hi+lo, rs1_names[r]); */
  | decode_sethi(val, r)  =&gt; print(pr, &quot;sethi %%hi(0x%x), %s&quot;, val, rs1_names[r]);
  | OR(0, imode(val), rd) =&gt; print(pr, &quot;set %d, %s&quot;, val, <a href="#NWD4">RD</a>);
  | cmp (rs1, roi)        =&gt; print(pr, &quot;cmp %s, %s&quot;, <a href="#NWD4">RS1</a>, <a href="#NWD4">ROI</a>);
  | ret()                 =&gt; print(pr, &quot;ret&quot;);
  | retl()                =&gt; print(pr, &quot;retl&quot;);
  | jmp (addr)            =&gt; print(pr, &quot;jmp %s&quot;, <a href="#NWD4">ADDR</a>);
  | call_ (addr)          =&gt; print(pr, &quot;call %s&quot;, <a href="#NWD4">ADDR</a>);
  | tst (rs2)             =&gt; print(pr, &quot;tst %s&quot;, <a href="#NWD4">RS2</a>);
  | not (rd)              =&gt; print(pr, &quot;not %s&quot;, <a href="#NWD4">RD</a>);
  | not2 (rs1, rd)        =&gt; print(pr, &quot;not %s, %s&quot;, <a href="#NWD4">RS1</a>, <a href="#NWD4">RD</a>);
  | neg (rd)              =&gt; print(pr, &quot;neg %s&quot;, <a href="#NWD4">RD</a>);
  | neg2 (rs2, rd)        =&gt; print(pr, &quot;neg %s, %s&quot;, <a href="#NWD4">RS2</a>, <a href="#NWD4">RD</a>);
  | inc (val, rd)         =&gt; print(pr, &quot;inc %d, %s&quot;, val, <a href="#NWD4">RD</a>);
  | inccc (val, rd)       =&gt; print(pr, &quot;inccc %d, %s&quot;, val, <a href="#NWD4">RD</a>);
  | dec (val, rd)         =&gt; print(pr, &quot;dec %d, %s&quot;, val, <a href="#NWD4">RD</a>);
  | deccc (val, rd)       =&gt; print(pr, &quot;deccc %d, %s&quot;, val, <a href="#NWD4">RD</a>);
  | btst (roi, rs1)       =&gt; print(pr, &quot;btst %s, %s&quot;, <a href="#NWD4">ROI</a>, <a href="#NWD4">RS1</a>);
  | bset (roi, rd)        =&gt; print(pr, &quot;bset %s, %s&quot;, <a href="#NWD4">ROI</a>, <a href="#NWD4">RD</a>);
  | bclr (roi, rd)        =&gt; print(pr, &quot;bclr %s, %s&quot;, <a href="#NWD4">ROI</a>, <a href="#NWD4">RD</a>);
  | btog (roi, rd)        =&gt; print(pr, &quot;btog %s, %s&quot;, <a href="#NWD4">ROI</a>, <a href="#NWD4">RD</a>);
  | clr (rd)              =&gt; print(pr, &quot;clr %s&quot;, <a href="#NWD4">RD</a>);
  | clr_ (addr)           =&gt; print(pr, &quot;clr [%s]&quot;, <a href="#NWD4">ADDR</a>);
  | clrb (addr)           =&gt; print(pr, &quot;clrb [%s]&quot;, <a href="#NWD4">ADDR</a>);
  | clrh (addr)           =&gt; print(pr, &quot;clrh [%s]&quot;, <a href="#NWD4">ADDR</a>);
  | mov (roi, rd)         =&gt; print(pr, &quot;mov %s, %s&quot;, <a href="#NWD4">ROI</a>, <a href="#NWD4">RD</a>);
  | restore_()            =&gt; print(pr, &quot;restore&quot;);
  | save_()               =&gt; print(pr, &quot;save&quot;);

         /* end of synthetics */

  | load_greg(addr, rd)      [name] =&gt; print(pr, &quot;%s [%s], %s&quot;, name, <a href="#NWD4">ADDR</a>, <a href="#NWD4">RD</a>);
  | load_freg(addr, fd)      [name] =&gt; print(pr, &quot;%s [%s], %s&quot;, name, <a href="#NWD4">ADDR</a>, <a href="#NWD4">FD</a>);
  | load_creg(addr, cd)      [name] =&gt; print(pr, &quot;%s [%s], %s&quot;, name, <a href="#NWD4">ADDR</a>, <a href="#NWD4">CD</a>);
  | load_asi (addr, asi, rd) [name] =&gt; print(pr, &quot;%s [%s]%d, %s&quot;, name, <a href="#NWD4">ADDR</a>, asi, <a href="#NWD4">RD</a>);

  | sto_greg(rd, addr)       [name] =&gt; print(pr, &quot;%s %s, [%s]&quot;, name, <a href="#NWD4">RD</a>, <a href="#NWD4">ADDR</a>);
  | sto_freg(fd, addr)       [name] =&gt; print(pr, &quot;%s %s, [%s]&quot;, name, <a href="#NWD4">FD</a>, <a href="#NWD4">ADDR</a>);
  | sto_creg(cd, addr)       [name] =&gt; print(pr, &quot;%s %s, [%s]&quot;, name, <a href="#NWD4">CD</a>, <a href="#NWD4">ADDR</a>);
  | sto_asi (rd, addr, asi)  [name] =&gt; print(pr, &quot;%s %s, [%s]%d&quot;, name, <a href="#NWD4">RD</a>, <a href="#NWD4">ADDR</a>, asi);

  | LDFSR(addr) [name] =&gt; print(pr, &quot;%s [%s], %%fsr&quot;, name, <a href="#NWD4">ADDR</a>);
  | LDCSR(addr) [name] =&gt; print(pr, &quot;%s [%s], %%csr&quot;, name, <a href="#NWD4">ADDR</a>);
  | STFSR(addr) [name] =&gt; print(pr, &quot;%s %%fsr, [%s]&quot;, name, <a href="#NWD4">ADDR</a>);
  | STCSR(addr) [name] =&gt; print(pr, &quot;%s %%csr, [%s]&quot;, name, <a href="#NWD4">ADDR</a>);
  | STDFQ(addr) [name] =&gt; print(pr, &quot;%s %%fq, [%s]&quot;, name, <a href="#NWD4">ADDR</a>);
  | STDCQ(addr) [name] =&gt; print(pr, &quot;%s %%cq, [%s]&quot;, name, <a href="#NWD4">ADDR</a>);

  /* don't bother with RDY, WRY, and friends */

  | alu (rs1, roi, rd) [name] =&gt; print(pr, &quot;%s %s, %s, %s&quot;, name, <a href="#NWD4">RS1</a>, <a href="#NWD4">ROI</a>, <a href="#NWD4">RD</a>);
  | branch^a (tgt)     [name] =&gt; print(pr, &quot;%s %s&quot;, name, dis_rel(rel, tgt));
  | call__ (tgt)              =&gt; print(pr, &quot;call %s&quot;, dis_rel(rel, tgt));

  | float_2 (fs2, fd)      [name] =&gt; print(pr, &quot;%s %s, %s&quot;,     name,      <a href="#NWD4">FS2</a>, <a href="#NWD4">FD</a>);
  | float_3 (fs1, fs2, fd) [name] =&gt; print(pr, &quot;%s %s, %s, %s&quot;, name, <a href="#NWD4">FS1</a>, <a href="#NWD4">FS2</a>, <a href="#NWD4">FD</a>);
  | float_cmp (fs1, fs2)   [name] =&gt; print(pr, &quot;%s %s, %s&quot;,     name,      <a href="#NWD4">FS1</a>, <a href="#NWD4">FS2</a>);

  | JMPL (addr, rd)    [name] =&gt; print(pr, &quot;jmpl %s, %s&quot;, <a href="#NWD4">ADDR</a>, <a href="#NWD4">RD</a>);
  | RETT (addr)        [name] =&gt; print(pr, &quot;rett [%s]&quot;, <a href="#NWD4">ADDR</a>);
  | trap (addr)        [name] =&gt; print(pr, &quot;%s [%s]&quot;, <a href="#NWD4">ADDR</a>);
  | UNIMP (n)          [name] =&gt; print(pr, &quot;unimp 0x%x&quot;, n);

  | inst = n =&gt; print(pr, &quot;.word 0x%08x&quot;, n);
  endmatch
}
</pre><blockquote>Defines <a href="#NWI-sparc_disassemble"><code>sparc_disassemble</code></a> (links are to index).<p>
</blockquote><p>
<h2><a name="NWDB">Index</a></h2>
<h3>Chunk names</h3>
<ul>
<li><a href="#NWD5"><i>&lt;definitions&gt;</i></a>: <a href="#NWspaB-spaA-1">U1</a>, <a href="#NWD5">D2</a>, <a href="#NWD7">D3</a>, <a href="#NWD8">D4</a>, <a href="#NWspaB-defB-4">D5</a>
<li><a href="#NWD3"><i>&lt;exported declarations&gt;</i></a>: <a href="#NWspaB-spaA.2-1">U1</a>, <a href="#NWD3">D2</a>
<li><a href="#NWspaB-fetE-1"><i>&lt;fetching specs&gt;</i></a>: <a href="#NWD1">U1</a>, <a href="#NWspaB-fetE-1">D2</a>
<li><a href="#NWD4"><i>&lt;macros&gt;</i></a>: <a href="#NWspaB-spaA-1">U1</a>, <a href="#NWD4">D2</a>
<li><a href="#NWspaB-spaA.2-1"><i>&lt;sparcdis.h&gt;</i></a>: <a href="#NWspaB-spaA.2-1">D1</a>
<li><a href="#NWspaB-spaA-1"><i>&lt;sparcdis.m&gt;</i></a>: <a href="#NWspaB-spaA-1">D1</a>
<li><a href="#NWD1"><i>&lt;sparcdis.spec&gt;</i></a>: <a href="#NWD1">D1</a>
<li><a href="#NWDA"><i>&lt;syntax patterns&gt;</i></a>: <a href="#NWD1">U1</a>, <a href="#NWDA">D2</a>
</ul>
<h3>Identifiers</h3>
<ul>
<li><a name="NWI-ADDR" href="#NWD4">ADDR</a>: <a href="#NWD4">D1</a>, <a href="#NWspaB-defB-4">U2</a>
<li><a name="NWI-CD" href="#NWD4">CD</a>: <a href="#NWD4">D1</a>, <a href="#NWspaB-defB-4">U2</a>
<li><a name="NWI-dis_addr" href="#NWD5">dis_addr</a>: <a href="#NWD4">U1</a>, <a href="#NWD5">D2</a>, <a href="#NWD8">U3</a>
<li><a name="NWI-dis_regaddr" href="#NWD8">dis_regaddr</a>: <a href="#NWD8">D1</a>
<li><a name="NWI-dis_roi" href="#NWD7">dis_roi</a>: <a href="#NWD4">U1</a>, <a href="#NWD7">D2</a>
<li><a name="NWI-FD" href="#NWD4">FD</a>: <a href="#NWD4">D1</a>, <a href="#NWspaB-defB-4">U2</a>
<li><a name="NWI-Fetcher" href="#NWD3">Fetcher</a>: <a href="#NWD3">D1</a>, <a href="#NWD5">U2</a>, <a href="#NWD7">U3</a>, <a href="#NWD8">U4</a>, <a href="#NWspaB-defB-4">U5</a>
<li><a name="NWI-FS1" href="#NWD4">FS1</a>: <a href="#NWD4">D1</a>, <a href="#NWspaB-defB-4">U2</a>
<li><a name="NWI-FS2" href="#NWD4">FS2</a>: <a href="#NWD4">D1</a>, <a href="#NWspaB-defB-4">U2</a>
<li><a name="NWI-Printer" href="#NWD3">Printer</a>: <a href="#NWD3">D1</a>, <a href="#NWspaB-defB-4">U2</a>
<li><a name="NWI-RD" href="#NWD4">RD</a>: <a href="#NWD4">D1</a>, <a href="#NWspaB-defB-4">U2</a>
<li><a name="NWI-RelPrinter" href="#NWD3">RelPrinter</a>: <a href="#NWD3">D1</a>, <a href="#NWspaB-defB-4">U2</a>
<li><a name="NWI-ROI" href="#NWD4">ROI</a>: <a href="#NWD4">D1</a>, <a href="#NWspaB-defB-4">U2</a>
<li><a name="NWI-RS1" href="#NWD4">RS1</a>: <a href="#NWD4">D1</a>, <a href="#NWD5">U2</a>, <a href="#NWD8">U3</a>, <a href="#NWspaB-defB-4">U4</a>
<li><a name="NWI-RS2" href="#NWD4">RS2</a>: <a href="#NWD4">D1</a>, <a href="#NWD5">U2</a>, <a href="#NWD7">U3</a>, <a href="#NWD8">U4</a>, <a href="#NWspaB-defB-4">U5</a>
<li><a name="NWI-sparc_disassemble" href="#NWspaB-defB-4">sparc_disassemble</a>: <a href="#NWD3">U1</a>, <a href="#NWspaB-defB-4">D2</a>
</ul>




</body></html>

